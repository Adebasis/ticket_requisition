
﻿
if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:false,configurable:true,writable:false,value:function(prop,handler){var
oldval=this[prop],newval=oldval,getter=function(){return newval;},setter=function(val){oldval=newval;return newval=handler.call(this,prop,oldval,val);};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:true,configurable:true});}}});}
if(!Object.prototype.unwatch){Object.defineProperty(Object.prototype,"unwatch",{enumerable:false,configurable:true,writable:false,value:function(prop){var val=this[prop];delete this[prop];this[prop]=val;}});}
if(!String.prototype.format){String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
String.prototype.replaceAll=function(search,replace){if(!replace)
return this;return this.replace(new RegExp('['+search+']','g'),replace);};String.prototype.DateWCF=function(){return new Date(parseInt(this.replace("/Date(","").replace(")/",""),10));};function kvp(name,val){this.name=name;this.val=val;this.context={};}
kvp.prototype.init=function(name,val,context){this.name=name;this.val=val;this.context=context;return this;}
function shortDateStringToDate(shortDateString){var d=null;if(shortDateString){var darr=shortDateString.split("/");if(darr.length==3){d=new Date(Number(darr[2]),Number(darr[0])-1,Number(darr[1]),0,0,0,0);}}
return d;}
function dateToShortDateString(d){if(d){return(d.getMonth()+1)+'/'+d.getDate()+'/'+(d.getYear()+1900);}}
(function($){$.fn.MiddleMiddle=(function(){$(this).css("position","absolute");$(this).css("top",Math.max(0,(($(window).height()-$(this).outerHeight())/2)+$(window).scrollTop())+"px");$(this).css("left",Math.max(0,(($(window).width()-$(this).outerWidth())/2)+$(window).scrollLeft())+"px");})})(jQuery,window);(function($){$.fn.RelativeMiddleMiddle=(function(parentElement){$(this).css("position","absolute");$(this).css("top",Math.max(0,((parentElement.height()-$(this).outerHeight())/2)+parentElement.scrollTop())+"px");$(this).css("left",Math.max(0,((parentElement.width()-$(this).outerWidth())/2)+parentElement.scrollLeft())+"px");})})(jQuery,window);(function($){$.QueryString=(function(a){if(a=="")return{};var b={};for(var i=0;i<a.length;++i){var p=a[i].split('=');if(p.length!=2)continue;b[p[0]]=decodeURIComponent(p[1].replace(/\+/g," "));}
return b;})(window.location.search.substr(1).split('&'))})(jQuery);(function($){$.IsNumeric=(function(a){return!isNaN(parseFloat(a))&&isFinite(a);})})(jQuery);(function($){$.fn.onSpacebar=(function(a){var _this=this;$(this).keypress(function(e){if(e.which==32){if(a(e,_this)){e.preventDefault();}}});})})(jQuery);(function($){$.fn.onEnterKey=(function(a){var _this=this;$(this).keypress(function(e){if(e.keyCode==13){if(a(e,_this)){e.preventDefault();}}});})})(jQuery);function refData(identifier,display,parentIdentifier,isAddtional){this.identifier=identifier;this.display=display;this.parentIdentifier=parentIdentifier;this.isAdditional=isAddtional;}
function refDataList(){this.list=null;this.isPulled=false;this.pullCompleted=function(caller){}
this.pulled=function(caller,jsonData){this.list=[];for(var ji=0;ji<jsonData.list.length;ji++){var rd=jsonData.list[ji];this.list.push(new refData(rd.i,rd.d,rd.p,rd.a));}
this.isPulled=true;this.pullCompleted(caller);}
this.pull=function(caller,refType){var _this=this;var url='';if(__masterSettings){url=__masterSettings.serviceBaseUrl;}
if(url!=''){url=url+'getRefData.ashx?refType='+refType;$.getJSON(url,'',function(json){_this.pulled(caller,json);});}}
this.customPull=function(caller,url){var _this=this;if(url!=''){$.getJSON(url,'',function(json){_this.pulled(caller,json);});}}
this.createFromJson=function(jsonData){this.list=[];for(var ji=0;ji<jsonData.list.length;ji++){var rd=jsonData.list[ji];this.list.push(new refData(rd.i,rd.d,rd.p,rd.a));}}
this.add=function(id,disp,pId,isAdd){if(!this.list)this.list=[];this.list.push(new refData(id,disp,pId,isAdd));}}
(function($){$.fn.BindRefData=(function(refdata){$(this).find('option').remove();for(var i=0;i<refdata.length;i++){if(refdata[i]){$(this).append('<option data-add="'+refdata[i].isAdditional+'" value="'+refdata[i].identifier+'">'+refdata[i].display+'</option>');}}})})(jQuery,window);(function($){$.fn.BindRefData=(function(refdata,defSel){$(this).find('option').remove();for(var i=0;i<refdata.length;i++){if(refdata[i]){var sel='';if(defSel&&refdata[i].identifier.toUpperCase()==defSel.toUpperCase())sel=' selected';$(this).append('<option data-add="'+refdata[i].isAdditional+'" value="'+refdata[i].identifier+'"'+sel+'>'+refdata[i].display+'</option>');}}})})(jQuery,window);(function($){$.fn.GetSelRefData=(function(){var rd=null;var sel=$(this).find(":selected");if(sel){var isAdd=false;if(sel.data('add'))isAdd=sel.data('add');rd=new refData(sel.val(),sel.text(),'',isAdd);}
return rd;})})(jQuery,window);function maxBlock(){this.wrapper=null;this.label=null;this.textarea=null;this.limit=0;this.holdLabel='';this.holdContent='';this.isContentValid=function(){return this.textarea.val().length<=this.limit;}
this.updateHolder=function(){var newHolder=this.label.html().search("BUSINESS");if(newHolder!=-1)
this.holdLabel="BUSINESS PURPOSE";newHolder=this.label.html().search("PERSONAL");if(newHolder!=-1)
this.holdLabel="NOTES FOR PERSONAL USE";newHolder=this.label.html().search("INSTRUCTIONS");if(newHolder!=-1)
this.holdLabel="INSTRUCTIONS FOR TICKET OFFICE";}
this.rebuildLabel=function(){this.updateHolder();var classes='maxBlockLbl';if(!this.isContentValid())classes+=' maxBlockLblInvalid';this.label.html(this.holdLabel+' <span class="'+classes+'">('+this.textarea.val().length+'/'+this.limit+')</span>');}
this.textareaChanged=function(){this.updateHolder();var currContent=this.textarea.val();if(currContent!=this.holdContent){this.rebuildLabel();}
this.holdContent=currContent;}
this.show=function(show){if(this.wrapper){if(show)this.rebuildLabel();else this.label.html(this.holdLabel);}}
this.init=function(blockElement,limit){var _this=this;this.wrapper=blockElement;this.label=this.wrapper.find('label').first();this.holdLabel=this.label.html();this.limit=limit;this.textarea=this.wrapper.find('textarea').first();this.textarea.on('change keyup paste',function(){_this.textareaChanged();});this.holdContent='';this.rebuildLabel();}}
﻿
function dashSct(){
	this.wrapper=null;
	this.content=null;
	this.spinner=null;
	this.busy=function(isBusy){
		if(isBusy)this.spinner.show();
		else this.spinner.hide();
	}
	this.failed=function(){
		this.busy(false);
		this.content.html('<div class="dashError">Unable to load</div>');
	}
	this.build=function(parent,className){
		this.wrapper=parent.find('.'+className).first();
		this.content=this.wrapper.find('.sectionContent').first();
		this.spinner=this.wrapper.find('.spin').first();this.busy(true);
	}
}
function dashboard(){
	this.wrapper=null;
	this.sctUpcoming=new dashSct();
	this.sctRecentAct=new dashSct();
	this.sctHelp=new dashSct();
	this.sctSummary=new dashSct();
	this.upcomingGameGrid=null;
	this.recentActivityGrid=null;
	this.gameChosen=function(gameId,newWin){
		var msg={};
		msg.gameId=gameId;
		msg.newWin=newWin;
		$.event.trigger({type:"gameChosen",message:msg,time:new Date()});
	}
	this.processUpcomingGames=function(json){
		var _this=this;
		var html='';
		if(json&&json.games){
			var list=[];
			for(var gi=0;gi<json.games.length;gi++){
				var g=new game();
				g.createReqGameFromJson(json.games[gi]);list.push(g);
			}
			this.upcomingGameGrid.jqGrid({
				datatype:"local",
				data:list,
				height:'100%',
				autowidth:true,
				beforeSelectRow:function(rowid,e){return false;},
				colNames:["GameId","Game Date","Opponent","Status","Deadline"],
				colModel:[{name:"gameId",hidden:true,key:true},{name:"gameDateJd",width:90,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"n/j/Y g:i A"}},
				{name:"opponentFullName",sortable:true,align:"left"},
				{name:"requestState",width:50,sortable:false,align:"left"},
				{name:"requestByJd",width:90,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"n/j/Y g:i A"}}],ondblClickRow:function(rowid){var reqState=_this.upcomingGameGrid.getRowData(rowid).requestState;
				if(!reqState||reqState.toUpperCase()!='CLOSED'){__masterSettings.removeSelection();_this.gameChosen(rowid,false);}},gridComplete:function(){var rows=_this.upcomingGameGrid.getDataIDs();for(a=0;a<rows.length;a++){row=_this.upcomingGameGrid.getRowData(rows[a]);if(row.requestState=='Closed'){$('tr#'+rows[a]).find('td').addClass('invalidGameRow');}}}});
		}
	}
this.processRecentActivity=function(json){var _this=this;var html='';if(json&&json.history){var list=[];for(var ri=0;ri<json.history.length;ri++){var r=new compRequest();r.createFromHistoryJson(json.history[ri]);list.push(r);}
this.recentActivityGrid.jqGrid({datatype:"local",data:list,shrinkToFit:true,height:'100%',autowidth:true,beforeSelectRow:function(rowid,e){return false;},colNames:["RequestId","Game","Recipient Name","Type","Comp","Purch","Created","Approved"],colModel:[{name:"requestId",hidden:true,key:true},{name:"gameDateJd",width:70,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"m/d/Y"}},{name:"recipientFullName",sortable:true,align:"left",classes:"wrappedCell"},{name:"requestTypeName",sortable:true,align:"left"},{name:"comp",width:40,sortable:true,align:"center"},{name:"purchased",width:40,sortable:true,align:"center"},{name:"createDateJd",width:70,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"m/d/Y"}},{name:"isApproved",hidden:true}],ondblClickRow:function(rowid){__masterSettings.removeSelection();window.open(__masterSettings.rootUrl+'reqInfo.aspx?request='+rowid);},gridComplete:function(){var rows=_this.recentActivityGrid.getDataIDs();for(a=0;a<rows.length;a++){row=_this.recentActivityGrid.getRowData(rows[a]);if(row.isApproved=='false'){$('tr#'+rows[a]).find('td').addClass('invalidGameRow');}}}});}}
this.processHelp=function(json){var html='<div class="helpList ecstyle"><ul>';if(json){var links=new refDataList();links.createFromJson(json);for(var li=0;li<links.list.length;li++){var lnk=links.list[li];html+='<li><i class="ui-icon ui-icon-link" style="padding-right: 5px"></i><a target="_blank" href="'+lnk.identifier+'">'+lnk.display+'</a></li>';}}
html+="For fulfillment issues, email <a href = 'mailto:eComps@nymets.com'>eComps@nymets.com</a>.<br/>For user creation issues, contact HR.";html+="</ul></div>";this.wrapper.find('.helpContent').first().html(html);}
this.processSummary=function(json){var poolUseDiv=this.wrapper.find('.poolUsage').first();var reqTypeUseDiv=this.wrapper.find('.reqTypeUsage').first();var poolHtml='';var rqHtml='';if(json&&json.allocUse){for(var i=0;i<json.allocUse.length;i++){var au=json.allocUse[i];var entryhtml='<div data-row-span="5" class="allocUseSummaryRow">';entryhtml+='<div data-field-span="3" class="smryRowHeader"><label></label>'+au.name+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>comp</label>'+au.compUsed+'/'+((au.compAllocated||au.compAllocated==0)?au.compAllocated:'--')+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>purchased</label>'+au.purchasedUsed+'/'+((au.purchasedAllocated||au.purchasedAllocated==0)?au.purchasedAllocated:'--')+'</div>';entryhtml+='</div>'
poolHtml+=entryhtml;}}
if(json&&json.reqTypes){for(var i=0;i<json.reqTypes.length;i++){var rt=json.reqTypes[i];var entryhtml='<div data-row-span="7" class="reqTypeUseSummaryRow">';entryhtml+='<div data-field-span="3" class="smryRowHeader"><label></label>'+rt.name+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>requests</label>'+rt.requests+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>comps</label>'+rt.comps+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>purchases</label>'+rt.purchases+'</div>';entryhtml+='<div data-field-span="1" class="smryCntr"><label>games</label>'+rt.games+'</div>';entryhtml+='</div>'
rqHtml+=entryhtml;}}
poolUseDiv.html(poolHtml);reqTypeUseDiv.html(rqHtml);}
this.load=function(){var _this=this;$.getJSON(__masterSettings.rootUrl+'_services/dashboard/user.ashx?mode=summary&dly=0','',function(json){_this.processSummary(json);_this.sctSummary.busy(false);}).error(function(){_this.sctSummary.failed();});$.getJSON(__masterSettings.rootUrl+'_services/dashboard/games.ashx?dly=0','',function(json){_this.processUpcomingGames(json);_this.sctUpcoming.busy(false);}).error(function(){_this.sctUpcoming.failed();});$.getJSON(__masterSettings.rootUrl+'_services/dashboard/requests.ashx?dly=0','',function(json){_this.processRecentActivity(json);_this.sctRecentAct.busy(false);}).error(function(){_this.sctRecentAct.failed();});$.getJSON(__masterSettings.rootUrl+'_services/dashboard/help.ashx?dly=0','',function(json){_this.processHelp(json);_this.sctHelp.busy(false);}).error(function(){_this.sctHelp.failed();});}
this.initialize=function(wrapperId){this.wrapper=$('#'+wrapperId);this.sctUpcoming.build(this.wrapper,'upcomingGames');this.sctRecentAct.build(this.wrapper,'recentActivity');this.sctHelp.build(this.wrapper,'help');this.sctSummary.build(this.wrapper,'summary');this.upcomingGameGrid=this.sctUpcoming.wrapper.find('#upcomingGameGrid').first();this.recentActivityGrid=this.sctRecentAct.wrapper.find('#recentActivityGrid').first();}}﻿function editReq(){this.wrapper=null;this.viewPanel=null;this.startMode='view';this.firstEdit=true;this.contentWrapper=null;this.actionsWrapper=null;this.mainContentWrapper=null;this.viewActionsWrapper=null;this.editActionsWrapper=null;this.txtComp=null;this.txtPurch=null;this.txtFName=null;this.txtLName=null;this.companyName=null;this.sponsorName=null;this.txtComments=null;this.commentsBlock=new maxBlock();this.instructionsBlock=new maxBlock();this.txtInstructions=null;this.locationSelector=null;this.deliverySelector=null;this.viewControls=[];this.editControls=[];this.canEdit=false;this.canDelete=false;this.canApprove=false;this.canFulfill=false;this.isApproved=false;this.approvedImg='public/images/maybe.png';this.approvedImgHover=null;this.isFulfilled=false;this.fulfilledImg='public/images/maybe.png';this.fulfilledImgHover=null;this.showEdit=function(show,withAnimation){if(show&&this.firstEdit){this.firstEdit=false;this.commentsBlock.init(this.wrapper.find('.commentsBlock').first(),250);this.instructionsBlock.init(this.wrapper.find('.instructionsBlock').first(),250);}
var _this=this;if(show){if(withAnimation){this.viewControls.fadeOut('fast',function(){_this.editControls.fadeIn('fast',function(){});});this.viewActionsWrapper.fadeOut('fast',function(){_this.editActionsWrapper.fadeIn('fast',function(){});});}
else{this.viewControls.hide();this.editControls.show();this.viewActionsWrapper.hide();this.editActionsWrapper.show();}}
else{if(withAnimation){this.editControls.fadeOut('fast',function(){_this.viewControls.fadeIn('fast',function(){});});this.editActionsWrapper.fadeOut('fast',function(){_this.viewActionsWrapper.fadeIn('fast',function(){});});}
else{this.editControls.hide();this.viewControls.show();this.editActionsWrapper.hide();this.viewActionsWrapper.show();}}
this.instructionsBlock.show(show);}
this.toggleViewEdit=function(){this.showEdit(this.viewActionsWrapper.is(':visible'),true);}
this.getValidationErrors=function(){var errors=[];var c=this.txtComp.val();var p=this.txtPurch.val();var fn=this.txtFName.val();var ln=this.txtLName.val();var nv=!(ln.trim().length==0||fn.trim().length==0);var cmtv=this.commentsBlock.isContentValid();var instrv=this.instructionsBlock.isContentValid();if(!nv)errors.push('Must enter name.');if(!cmtv)errors.push('Comments are too long.');if(!instrv)errors.push('Instructions are too long.');return errors;}
this.getValidationWarnings=function(){var warnings=[];if(parseInt(this.txtPurch.val())>0&&__masterSettings.currentUser&&!__masterSettings.currentUser.hasCc){warnings.push('Your request will be updated but you do not currently have a credit card on file.');var ccMsg=(__masterSettings.currentUser.hasAd)?'follow the instructions for submitting a credit card in the help section of the eComps home page.':'check with your manager on how to submit a credit card to the ticket office.';warnings.push('Since you are purchasing tickets, to make sure this request can be fulfilled please '+ccMsg);}
return warnings;}
this.update=function(){var errors=this.getValidationErrors();var warnings=this.getValidationWarnings();if(errors.length==0){if(confirm("Are you sure you want to update this request?")){if(warnings.length>0){alert(warnings.join('\n'));}
__masterSettings.showLoadingOverlay();$('.submitRequest').click();location.reload();}}
else{__masterSettings.alert('Please fix the following problems:\n'+errors.join('\n'));}}
this.del=function(){if(confirm("Are you sure you want to delete this request?")){__masterSettings.showLoadingOverlay();$('.deleteRequest').click();}}
this.approve=function(){if(confirm("Are you sure you want to approve this request?")){__masterSettings.showLoadingOverlay();$('.approveRequest').click();}}
this.disapprove=function(){if(confirm("Are you sure you want to remove approval of this request?")){__masterSettings.showLoadingOverlay();$('.disapproveRequest').click();}}
this.setPermissions=function(edit,del,approve,fulfill){this.canEdit=edit;this.canApprove=approve;this.canFulfill=fulfill;this.canDelete=del;}
this.setReqDetails=function(isApproved,isFulfilled){this.isApproved=isApproved;this.isFulfilled=isFulfilled;this.approvedImg='public/images/'+((this.isApproved==null)?'maybe':(this.isApproved)?'yes':'no')+'.png';this.approvedImgHover=(this.isApproved==null)?'Pending Approval':(this.isApproved)?'Approved':'Not Approved';this.fulfilledImg='public/images/'+((this.isFulfilled)?'yes':'maybe')+'.png';this.fulfilledImgHover=(this.isFulfilled)?'Fulfilled':'Not Fulfilled';}
this.initialize=function(wrapperId){var _this=this;this.wrapper=$('#'+wrapperId);this.viewPanel=this.wrapper.find('.viewReqPanel').first();this.viewControls=this.wrapper.find('.viewCtrl');this.editControls=this.wrapper.find('.editCtrl');this.contentWrapper=this.wrapper.find('.reqContent').first();this.actionsWrapper=this.contentWrapper.find('.reqActions').first();this.viewActionsWrapper=this.actionsWrapper.find('.viewActions').first();this.editActionsWrapper=this.actionsWrapper.find('.editActions').first();this.mainContentWrapper=this.contentWrapper.find('.reqMainContent').first();this.txtComp=this.wrapper.find('.txtComp').first();this.txtPurch=this.wrapper.find('.txtPurch').first();this.txtFName=this.wrapper.find('.txtFName').first();this.txtLName=this.wrapper.find('.txtLName').first();this.companyName=this.wrapper.find('.companyName').first();this.sponsorName=this.wrapper.find('.sponsorName').first();this.txtComments=this.wrapper.find('.txtComments').first();this.txtInstructions=this.wrapper.find('.txtInstructions').first();this.locationSelector=this.wrapper.find('.selLocation').first();this.deliverySelector=this.wrapper.find('.selDelivery').first();var approvImg=this.wrapper.find('.imgApproved').first();approvImg.attr('src',__masterSettings.rootUrl+this.approvedImg);approvImg.data('hover',this.approvedImgHover);var flflImg=this.wrapper.find('.imgFulfilled').first();flflImg.attr('src',__masterSettings.rootUrl+this.fulfilledImg);flflImg.data('hover',this.fulfilledImgHover);this.wrapper.find('.reqActionImg').on('mouseover',function(e){$(this).attr('src',$(this).attr('src').replace('_off','_on'));});this.wrapper.find('.reqActionImg').on('mouseout',function(e){$(this).attr('src',$(this).attr('src').replace('_on','_off'));});var canAct=false;if(this.canEdit){$('.imgEdit').show();$('.imgEdit').on('click',function(){_this.toggleViewEdit();});$('.imgView').show();$('.imgView').on('click',function(){_this.toggleViewEdit();});$('.submitRequestValidate').on('click',function(){_this.update();});canAct=true;}
if(this.canDelete){$('.imgDelete').show();$('.imgDelete').on('click',function(){_this.del();});canAct=true;}
if(this.canApprove){if(this.isApproved==null||this.isApproved){$('.imgDisapprove').show();$('.imgDisapprove').on('click',function(){_this.disapprove();});canAct=true;}
if(this.isApproved==null||!this.isApproved){$('.imgApprove').show();$('.imgApprove').on('click',function(){_this.approve();});canAct=true;}}
if(!canAct){this.viewActionsWrapper.hide();this.editActionsWrapper.hide();this.actionsWrapper.css('width','0px');}
else{this.showEdit(this.startMode=='edit',false);}
this.wrapper.show();this.mainContentWrapper.css('width',(this.contentWrapper.width()-this.actionsWrapper.width())+'px');}}﻿
function game(){this.gameId='';this.gameDate=null;this.gameDateJd=null;this.requestBy=null;this.requestByJd=null;this.opponentCode='';this.opponentNickName='';this.opponentShortName='';this.opponentFullName='';this.demand='';this.requestState='';this.isRequestable=false;this.promotions=[];this.createReqGameFromJson=function(json){this.gameId=json.gameId;this.gameDate=new moment(json.gamedate);this.gameDateJd=this.gameDate.toDate();this.opponentCode=json.oppCode;this.opponentNickName=json.oppNick;this.opponentShortName=json.oppShort;this.opponentFullName=this.opponentShortName+' '+this.opponentNickName;this.isRequestable=null;this.requestBy=new moment(json.deadline);this.requestByJd=this.requestBy.toDate();this.demand=json.demand;this.requestState=json.reqState;this.promotions=[];if(json.promos&&json.promos.length>0)this.promotions=json.promos;}
this.createUserReqGameFromJson=function(json){this.createReqGameFromJson(json.game);this.isRequestable=json.isReq;}}
function gameList(){this.list=[];this.maxGameDate=null;this.minGameDate=null;this.createFromJson=function(json,isUser){this.list=[];this.maxGameDate=null;this.minGameDate=null;for(var gi=0;gi<json.games.length;gi++){var g=new game();if(isUser)g.createUserReqGameFromJson(json.games[gi]);else g.createReqGameFromJson(json.games[gi]);this.list.push(g);if(!this.maxGameDate||g.gameDate.isAfter(this.maxGameDate)){this.maxGameDate=g.gameDate;}
if(!this.minGameDate||g.gameDate.isBefore(this.minGameDate)){this.minGameDate=g.gameDate;}}}
this.createCalendarEvents=function(){var evs=[];for(var gi=0;gi<this.list.length;gi++){var g=this.list[gi];var gev={};var titleHtml='<div class="calGameWrapper grid-form" data-gameId="'+g.gameId+'">';titleHtml+='<div class="calGevTitle">';titleHtml+='<div class="calGevLogo"><img src="'+__masterSettings.rootUrl+'public/images/logos/'+g.opponentCode+'.png'+'" /></div>';titleHtml+='<div class="calGevLc">';titleHtml+='<div class="calGevLcContent">';titleHtml+='<div class="calGevTitleLine">'+g.opponentShortName+'</div>';titleHtml+='<div class="calGevTitleLine">'+g.opponentNickName+'</div>';titleHtml+='</div>';titleHtml+='</div>';titleHtml+='<div class="calGevRc">';titleHtml+='<div class="calGevRcContent">';titleHtml+='<div class="calGevLogoContainer">';titleHtml+='</div>';titleHtml+='</div>';titleHtml+='</div>';titleHtml+='<div style="clear: both"></div>';titleHtml+='</div>';if(g.promotions&&g.promotions.length>0){titleHtml+='<div class="calGevBot">';titleHtml+='<div class="calGevPromosLbl">PROMOTIONS</div>'
titleHtml+='<div class="calGevPromos">';for(var pi=0;pi<g.promotions.length;pi++){titleHtml+='<div class="calGevPromoItem">'+g.promotions[pi].promo+'</div>';}
titleHtml+='</div>';titleHtml+='</div>';}
titleHtml+='</div>'
gev['id']=g.gameId;gev['canClick']=g.isRequestable?'1':'0';gev['title']=titleHtml;gev['start']=g.gameDate.format("YYYY-MM-DD");gev['className']='calendarGameEvent';evs.push(gev);}
return evs;}
this.getGame=function(gameId){var selGame=null;for(var gi=0;gi<this.list.length;gi++){if(this.list[gi].gameId==gameId){selGame=this.list[gi];break;}}
return selGame;}}
function gameCalendar(height,width){this.calendarWrapper=null;this.calendarContainer=null;this.calendar=null;this.games=new gameList();this.height=height;this.width=width;this.userGamesRetrieved=function(){}
this.isBuilt=false;this.iconButtonMgr=new iconButtons();this.calActionsWrapper=null;this.nextBtn=null;this.prevBtn=null;this.hasNextMonth=false;this.hasPrevMonth=false;this.getUserGames=function(async){var _this=this;var url=__masterSettings.serviceBaseUrl+'gamedata.ashx?mode=user';if(async){$.getJSON(url,'',function(json){_this.games.createFromJson(json,true);_this.userGamesRetrieved();});}
else{$.ajax({url:url,type:'GET',dataType:'json',async:false,success:function(json){_this.games.createFromJson(json,true);}});}}
this.chooseGame=function(gameId,newWin){var msg={};msg.gameId=gameId;msg.newWin=newWin;$.event.trigger({type:"gameChosen",message:msg,time:new Date()});}
this.getGameTooltip=function(gameId){var gameTip=null;var game=this.games.getGame(gameId);if(game){gameTip={};gameTip.title='';gameTip.body='<div class="calGameTipTitle">';gameTip.body+='<div class="calGameTipDate">'+game.gameDate.format('MM/DD/YYYY h:mm A')+'</div>';gameTip.body+='<div class="calGameTipOpp">vs '+game.opponentFullName+'</div>';gameTip.body+='</div>';gameTip.body+='<div class="calGameTipBody">';if(game.isRequestable){if(game.requestState&&game.requestState.toUpperCase()=='LATE'){gameTip.body+='<div class="calGameBodyName">Status</div>';gameTip.body+='<div class="calGameBodyVal">All requests will be marked as late and will require approval.</div>';}
else{gameTip.body+='<div class="calGameBodyName">Enter Requests By</div>';gameTip.body+='<div class="calGameBodyVal">'+game.requestBy.format('MM/DD/YYYY h:mm A')+'</div>';}}
else{gameTip.body+='<div class="calGameBodyName">Status</div>';gameTip.body+='<div class="calGameBodyVal">This game is not currently available for requests.</div>';}
gameTip.body+='<div class="calGameBodyName">Promotions</div>';gameTip.body+='<div class="calGameBodyVal">'
if(game.promotions.length>0){for(var pi=0;pi<game.promotions.length;pi++){var p=game.promotions[pi];gameTip.body+='<div class="calGameBodyPromo">'
gameTip.body+=p.promo;if(p.presby||p.presby!='')gameTip.body+=' (presented by '+p.presby+')';if(p.restr&&p.restr!='')gameTip.body+=' *'+p.restr;gameTip.body+='</div>';}}
else{gameTip.body+='No promotions';}
gameTip.body+='</div>';}
return gameTip;}
this.handleDisp=function(){var dispDate=this.calendar.fullCalendar('getDate');var monthDisp='';this.hasPrevMonth=false;this.hasNextMonth=false;if(dispDate){monthDisp=dispDate.format('MMMM').toUpperCase();if(this.games.minGameDate&&this.games.maxGameDate){var nextMonth=Number(dispDate.format('M'))+1;var prevMonth=nextMonth-2;if(nextMonth<=Number(this.games.maxGameDate.format("M"))){this.hasNextMonth=true;}
if(prevMonth>=Number(this.games.minGameDate.format("M"))){this.hasPrevMonth=true;}}}
this.calendarWrapper.find('.calMonthName').first().html(monthDisp);this.nextBtn.css('opacity',(this.hasNextMonth)?'1':'0');this.nextBtn.css('cursor',(this.hasNextMonth)?'pointer':'default');this.prevBtn.css('opacity',(this.hasPrevMonth)?'1':'0');this.prevBtn.css('cursor',(this.hasPrevMonth)?'pointer':'default');var height=this.calendarWrapper.find('.fc-day').first().height();this.calendarWrapper.find('.calGameWrapper').css('height',height+'px');this.calendarWrapper.find('.calGameWrapper').on('mouseover',function(){$(this).addClass('calendarGameDayReqHover');});this.calendarWrapper.find('.calGameWrapper').on('mouseout',function(){$(this).removeClass('calendarGameDayReqHover');});var _this=this;$('.calGameWrapper').each(function(){var day=$(this);day.qtip({content:'game tooltip',show:{delay:700},events:{show:function(event,api){var $element=$(this).data('qtip').elements.target;var gameTip=_this.getGameTooltip($element.data('gameid'));if(gameTip){$element.qtip('option',{'content.text':gameTip.body});$element.qtip('option',{'content.title':gameTip.title});}
else{event.preventDefault();}}},position:{my:'top center',at:'bottom center'},style:{classes:'gameTooltip',tip:{corner:'top center'}}});});}
this.actionBtnClicked=function(msg){if(msg.sender=='gamecal'){var arg=msg.arg;if(arg=='prev'&&this.hasPrevMonth){this.calendar.fullCalendar('prev');}
else if(arg=='next'&&this.hasNextMonth){this.calendar.fullCalendar('next');}
this.handleDisp();}}
this.initialize=function(wrapperId,getGames){var _this=this;this.calendarWrapper=$('#'+wrapperId);this.calendarContainer=this.calendarWrapper.find('.calContainer').first();this.calendar=this.calendarWrapper.find('.calendar').first();this.calActionsWrapper=this.calendarWrapper.find('.calActions').first();$(document).on("iconButtonClicked",function(e){_this.actionBtnClicked(e.message);});var icBtns=[];icBtns.push(new icBtn('prev','prev',100));icBtns.push(new icBtn('next','next',200));var buttonHtml='';if(icBtns&&icBtns.length>0){icBtns=_.sortBy(icBtns,function(item){return((item.order)?item.order:9999);});for(var bi=0;bi<icBtns.length;bi++){var ib=icBtns[bi];if(ib.action=='text'){buttonHtml+='<span class="calActionTextCenterer"><span class="calActionText '+ib.name+'"></span></span>';}
else{buttonHtml+='<img class="iconButton calButton '+((ib.cssClass)?ib.cssClass:'')+'" data-name="'+ib.name+'" data-arg="'+ib.action+'" src="'+__masterSettings.rootUrl+this.iconButtonMgr.getImgRelUrl(ib.name)+'" />';}}}
if(buttonHtml!=''){this.calActionsWrapper.html(buttonHtml);}
this.iconButtonMgr.latch('gamecal',this.calActionsWrapper);this.nextBtn=this.calActionsWrapper.find('img[data-arg="next"]').first();this.prevBtn=this.calActionsWrapper.find('img[data-arg="prev"]').first();if(getGames){this.getUserGames(true);}}
this.build=function(){var _this=this;var evs=this.games.createCalendarEvents();this.calendar.fullCalendar({header:false,fixedWeekCount:false,defaultDate:__masterSettings.gameCalToday.format('YYYY-MM-DD'),dayRender:function(date,cell){var canClick='0';var gameId=null;var cal=date.format("YYYY-MM-DD");var dateGame=_.find(_this.games.list,function(g){return g.gameDate.format("YYYY-MM-DD")==cal;});if(dateGame){if(dateGame.isRequestable){cell.addClass('calendarGameDayReq');canClick='1';}
else{cell.addClass('calendarGameDay');}
gameId=dateGame.gameId;}
else{cell.addClass('calendarNonGameDay');}
cell.data('canClick',canClick);if(gameId){cell.data('gameId',gameId);}},dayClick:function(date,jsEvent,view){var canClick=$(this).data('canClick')=='1';if(canClick){var gameId=$(this).data('gameId');_this.chooseGame(gameId,false);}},eventClick:function(calEvent,jsEvent,view){var canClick=calEvent['canClick']=='1';if(canClick){var gameId=calEvent['id'];_this.chooseGame(gameId,false);}},eventAfterRender:function(event,element,view){element.find('.fc-title').html(event.title);},events:evs});this.handleDisp();this.isBuilt=true;}}﻿
function header(){this.wrapper=null;this.actionsWrapper=null;this.impersonateSelector=null;this.gameCalEnabled=true;this.impersonateId=null;this.iconButtonMgr=new iconButtons();this.gamecal=null;this.relHome='';this.impersonateUserList=new refDataList();this.impersonateUserList.pullCompleted=function(caller){caller.impersonateSelector.BindRefData(caller.impersonateUserList.list);caller.changeUserReady();}
this.userImpersonateModal=new modal();this.userImpersonateModal.postFadeIn=function(){this.element.find('.userImpSelect').first().focus();}
this.helpModal=new modal();this.helpModal.preFadeIn=function(){this.caller.helpForm.rebuild();}
this.helpModal.postFadeIn=function(){this.caller.helpForm.refresh();}
this.helpForm=new ecHelp();this.unpwModal=new modal();this.unpwModal.preFadeIn=function(){this.caller.unpwForm.rebuild();}
this.unpwModal.postFadeIn=function(){this.caller.unpwForm.refresh();}
this.unpwForm=new externalUpdater();this.clipCopForm=new clipCopier();this.clipCopModal=new modal();this.clipCopModal.postFadeIn=function(){this.caller.clipCopForm.show();}
this.gamecalModal=new modal();this.setup=function(wrapperId,icBtns){var _this=this;this.wrapper=$('#'+wrapperId);this.actionsWrapper=this.wrapper.find('.actions').first();var buttonHtml='';if(icBtns&&icBtns.length>0){icBtns=_.sortBy(icBtns,function(item){return((item.order)?item.order:9999);});for(var bi=0;bi<icBtns.length;bi++){var ib=icBtns[bi];buttonHtml+='<img data-hover="'+ib.dispName+'" class="iconButton headerButton qtBottomCenter '+((ib.cssClass)?ib.cssClass:'')+'" data-name="'+ib.name+'" data-arg="'+ib.action+'" src="'+__masterSettings.rootUrl+this.iconButtonMgr.getImgRelUrl(ib.name)+'" />';}}
if(buttonHtml!=''){this.actionsWrapper.html(buttonHtml);}
this.iconButtonMgr.latch('master',this.wrapper);$('.ahome').attr('href',__masterSettings.rootUrl+this.relHome);if(this.gameCalEnabled){this.gamecal=new gameCalendar(0,0);this.gamecal.initialize('calWrapper',false);this.gamecalModal.setup($('#calWrapper'),this);}
this.helpForm.initialize(this.wrapper.find('#helpContainer').first());this.helpModal.setup($('#helpContainer'),this);this.unpwForm.initialize(this.wrapper.find('#unpwContainer').first());this.unpwModal.setup($('#unpwContainer'),this);var clipCopContainer=this.wrapper.find('#copyClipboardContainer').first();this.clipCopForm.initialize(clipCopContainer);this.clipCopModal.setup(clipCopContainer,this);this.userImpersonateModal.setup(this.wrapper.find('.userImpersonate').first(),this);this.impersonateSelector=this.userImpersonateModal.element.find('.userImpSelect').first();this.userImpersonateModal.element.find('.impersonate').first().on('click',function(){_this.impersonateId=null;var sel=_this.impersonateSelector.val();if(sel){_this.impersonateId=sel;_this.userImpersonateModal.element.find('.impersonateId').first().val(_this.impersonateId);_this.userChangeSelected();}});this.wrapper.find('.userImpersonate').first().onEnterKey(function(e,el){_this.wrapper.find('.impersonate').first().click();return true;});this.wrapper.find('.changeUser').on('click',function(){_this.changeUser();});$(document).on("gameChosen",function(e){_this.startNewRequest(e.message);});$(document).on("clipboardCopierRequested",function(e){_this.showClipboardCopier(e.message);});}
this.showHelpForm=function(){if(!this.helpForm.isBuilt)
this.helpForm.build();var _this=this;var req=new overlayRequest(true,this.helpModal);$.event.trigger({type:'overlayRequested',message:req,time:new Date()});}
this.showUnpwForm=function(){var _this=this;var req=new overlayRequest(true,this.unpwModal);$.event.trigger({type:'overlayRequested',message:req,time:new Date()});}
this.showClipboardCopier=function(textToCopy){this.clipCopForm.setText(textToCopy);var _this=this;var req=new overlayRequest(true,this.clipCopModal);$.event.trigger({type:'overlayRequested',message:req,time:new Date()});}

this.showGameCal=function(){
	if(!this.gamecal.isBuilt){
		this.gamecal.getUserGames(false);
		this.gamecalModal.element.show();
		this.gamecal.build();
	}
	var _this=this;
	var req=new overlayRequest(true,this.gamecalModal);
	$.event.trigger({type:"overlayRequested",message:req,time:new Date()});
}

this.startNewRequest=function(msg){}
this.changeUserReady=function(){var _this=this;var req=new overlayRequest(true,this.userImpersonateModal);$.event.trigger({type:"overlayRequested",message:req,time:new Date()});}
this.changeUser=function(){if(this.impersonateUserList.isPulled){this.changeUserReady();}
else{this.impersonateUserList.pull(this,'ImpersonableUsers');}}
this.userChangeSelected=function(){}}
function ecHelp(){this.wrapper=null;this.overlay=null;this.messageBlock=new maxBlock();this.message=null;this.submitButton=null;this.resultDiv=null;this.isBuilt=false;this.showOverlay=function(show){this.overlay.css('top',this.wrapper.offset().top);this.overlay.css('left',this.wrapper.offset().left);this.overlay.css('width',this.wrapper.outerWidth());this.overlay.css('height',this.wrapper.outerHeight());if(show)this.overlay.show();else this.overlay.hide();}
this.refresh=function(){this.message.val('');this.messageBlock.rebuildLabel();this.message.focus();}
this.rebuild=function(){this.submitButton.show();this.resultDiv.hide();this.refresh();}
this.submitCompleted=function(resp){if(resp.success){this.refresh();this.submitButton.hide();this.resultDiv.show();}
else{__masterSettings.alert('Unable to send message at this time. Please try again later.');}
this.showOverlay(false);}
this.validate=function(){var errors=[];var msg=this.message.val();var mv=this.messageBlock.isContentValid();if(msg.trim().length==0)errors.push('Must enter a message to send.');if(!mv)errors.push('Message is too long.');return errors;}
this.submit=function(){var _this=this;this.showOverlay(true);var err=this.validate();if(err.length==0){var req={};req['message']=this.message.val();var url=__masterSettings.serviceBaseUrl+'contact.ashx?dly=700';$.ajax({url:url,type:'post',data:JSON.stringify(req),success:function(json){_this.submitCompleted(json);}});}
else{__masterSettings.alert('Please fix the following problems:\n'+err.join('\n'));this.showOverlay(false);}}
this.processHelp=function(json){var html='<div class="helpLinks"><ul>';if(json){var links=new refDataList();links.createFromJson(json);for(var li=0;li<links.list.length;li++){var lnk=links.list[li];html+='<li><a target="_blank" href="'+lnk.identifier+'">'+lnk.display+'</a></li>';}}
html+="</ul></div>";this.wrapper.find('.helpContent').first().html(html);}
this.build=function(){var _this=this;$.getJSON(__masterSettings.rootUrl+'_services/dashboard/help.ashx?dly=0','',function(json){_this.processHelp(json);});this.isBuilt=true;}
this.initialize=function(containerElement){var _this=this;this.wrapper=containerElement.find('.helpWrapper').first();this.overlay=this.wrapper.find('.helpOverlay').first();this.message=this.wrapper.find('.message').first();this.messageBlock.init(this.wrapper.find('.messageBlock').first(),1000);this.submitButton=this.wrapper.find('.contactSubmit').first();this.resultDiv=this.wrapper.find('.contactSuccess').first();this.resultDiv.hide();var ccImgUrl=__masterSettings.rootUrl+'public/images/grid'+((__masterSettings.currentUser&&__masterSettings.currentUser.hasCc)?"yes":"no")+'.png';this.wrapper.find('.hasCc').first().html('<img src="'+ccImgUrl+'" />');this.submitButton.on('click',function(){_this.submit();});}}
function clipCopier(){this.wrapper=null;this.txtbox=null;this.setText=function(textToCopy){this.txtbox.val(textToCopy);}
this.show=function(){this.txtbox.select();}
this.initialize=function(containerElement){this.wrapper=containerElement.find('.copyWrapper').first();this.txtbox=this.wrapper.find('.txtCopy').first();}}
function externalUpdater(){this.wrapper=null;this.overlay=null;this.un=null;this.pw=null;this.submitButton=null;this.removeButton=null;this.resultDiv=null;this.showOverlay=function(show){this.overlay.css('top',this.wrapper.offset().top);this.overlay.css('left',this.wrapper.offset().left);this.overlay.css('width',this.wrapper.outerWidth());this.overlay.css('height',this.wrapper.outerHeight());if(show)this.overlay.show();else this.overlay.hide();}
this.refresh=function(){this.pw.val('');this.un.focus();}
this.rebuild=function(){this.submitButton.show();this.removeButton.show();this.resultDiv.hide();this.refresh();}
this.submitCompleted=function(resp,isRemoval){if(resp.success){this.refresh();this.submitButton.hide();this.removeButton.hide();this.resultDiv.html(((isRemoval)?'REMOVED':'UPDATED')+' SUCCESSFULLY.');this.resultDiv.show();if(isRemoval){this.un.val('');this.pw.val('');}}
else{var errArr=[];errArr.push('Unable to update credentials for the following reasons:');if(resp.errors&&resp.errors.length>0){if(resp.errors[0].substring(0,7)=='Invalid'){if(resp.errors[0]=='Invalid Password')errArr.push('The password did not meet the complexity requirements.');else errArr.push('The username did not meet the complexity requirements.');errArr.push('The rules are as follows:');}
for(var ei=1;ei<resp.errors.length;ei++){errArr.push(resp.errors[ei]);}}
else{errArr.push('System error.')
errArr.push('Please try again later.');}
__masterSettings.alert(errArr.join('\n'));}
this.showOverlay(false);}
this.remove=function(){var _this=this;this.showOverlay(true);var req={};req['action']='unpw';var unpwObj={};unpwObj['rem']=true;req['message']=JSON.stringify(unpwObj);var url=__masterSettings.serviceBaseUrl+'userServices.ashx';$.ajax({url:url,type:'post',data:JSON.stringify(req),success:function(json){_this.submitCompleted(json,true);}});}
this.validate=function(){var errors=[];var un=this.un.val();var pw=this.pw.val();if(un.trim().length==0)errors.push('Must enter a username to send.');if(pw.trim().length==0)errors.push('Must enter a password to send.');return errors;}
this.submit=function(){var _this=this;this.showOverlay(true);var err=this.validate();if(err.length==0){var req={};req['action']='unpw';var unpwObj={};unpwObj['un']=this.un.val();unpwObj['pw']=this.pw.val();req['message']=JSON.stringify(unpwObj);var url=__masterSettings.serviceBaseUrl+'userServices.ashx';$.ajax({url:url,type:'post',data:JSON.stringify(req),success:function(json){_this.submitCompleted(json,false);}});}
else{__masterSettings.alert('Please fix the following problems:\n'+err.join('\n'));this.showOverlay(false);}}
this.initialize=function(containerElement){var _this=this;this.wrapper=containerElement.find('.unpwWrapper').first();this.overlay=this.wrapper.find('.unpwOverlay').first();this.un=this.wrapper.find('.username').first();this.pw=this.wrapper.find('.password').first();this.submitButton=this.wrapper.find('.unpwSubmit').first();this.removeButton=this.wrapper.find('.unpwRemove').first();this.resultDiv=this.wrapper.find('.unpwSuccess').first();this.resultDiv.hide();this.submitButton.on('click',function(){_this.submit();});this.removeButton.on('click',function(){if(confirm("Are you sure you want to remove external access to eComps?")){_this.remove();}});this.wrapper.onEnterKey(function(e,el){return true;});}}﻿function compRequest(){this.requestId=null;this.gameId=null;this.requestor=null;this.owner=null;this.season=null;this.gameDate=null;this.gameDateJd=null;this.requestorFullName=null;this.ownerFullName=null;this.requestTypeCode=null;this.requestTypeName=null;this.comp=null;this.purchased=null;this.locationTypeCode=null;this.locationTypeName=null;this.deliveryTypeCode=null;this.companyName=null;this.deliveryTypeName=null;this.recipientFullName=null;this.recipientEmail=null;this.instructions=null;this.userComments=null;this.createDate=null;this.createDateJd=null;this.lastUpdate=null;this.lastUpdateJd=null;this.isApproved=null;this.isApprovedImg='';this.isFulfilled=null;this.isFulfilledImg='';this.isPaid=null;this.isPaidImg='';this.ticketsCreated=null;this.ticketsScanned=null;this.usedDesc=null;this.createFromHistoryJson=function(json){this.requestId=json.rId;this.gameDate=new moment(json.gDate);this.gameDateJd=this.gameDate.toDate();this.requestorFullName=json.rName;this.requestTypeName=json.rt;this.comp=json.c;this.purchased=json.p;this.locationTypeName=json.lt;this.deliveryTypeName=json.dt;this.recipientFullName=json.recName;this.recipientEmail=json.recEmail;this.userComments=json.userComments;this.instructions=json.instr;this.companyName=json.companyName;this.createDate=new moment(json.cDate);this.createDateJd=this.createDate.toDate();this.isApproved=json.appr;this.isApprovedImg=(json.appr==null)?null:(json.appr)?(__masterSettings.rootUrl+'public/images/gridYes.png'):(__masterSettings.rootUrl+'public/images/gridNo.png');this.isFulfilled=json.flfl;this.isFulfilledImg=(json.flfl)?(__masterSettings.rootUrl+'public/images/gridYes.png'):null;this.isPaid=json.paid;this.isPaidImg=(json.paid)?(__masterSettings.rootUrl+'public/images/gridYes.png'):null;this.ticketsCreated=json.ctix;this.ticketsScanned=json.stix;if(this.ticketsCreated&&this.ticketsScanned)this.usedDesc=this.ticketsScanned+'/'+this.ticketsCreated;else if(this.ticketsCreated)this.usedDesc='0/'+this.ticketsCreated;else this.usedDesc='';}}
function reqHistory(){this.requests=[];this.searchSuccess=false;this.filterWrapper=null;this.resultsWrapper=null;this.resultsGrid=null;this.primaryFilter=null;this.seasonSel=null;this.gameSel=null;this.viewForSel=null;this.requestTypeSel=null;this.deptSel=null;this.apprSel=null;this.txtRcp=null;this.rblRcp=null;this.firstSearch=true;this.iconButtonMgr=new iconButtons();this.getIntendedGridHeight=function(){return $(window).height()-this.resultsWrapper.offset().top-40;},this.processSearchResults=function(json){this.requests=[];if(json.success){this.searchSuccess=true;for(var ri=0;ri<json.history.length;ri++){var r=new compRequest();r.createFromHistoryJson(json.history[ri]);this.requests.push(r);}}
else{this.searchSuccess=false;__masterSettings.alert('An error occurred while searching. Please try again later.');}}
this.searchCompleted=function(){if(this.searchSuccess){var _this=this;if(this.firstSearch){this.firstSearch=false;var colModel=[{name:"requestId",hidden:true,key:true},{name:"requestorFullName",width:130,sortable:true,align:"left"},{name:"gameDateJd",width:70,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"m/d/Y"}},{name:"createDateJd",width:70,sortable:true,sorttype:'date',align:"center",formatter:"date",formatoptions:{newformat:"m/d/Y"}},{name:"recipientFullName",width:130,sortable:true,align:"left",classes:"wrappedCell"},{name:"requestTypeName",width:100,sortable:true,align:"left"},{name:"comp",width:50,sortable:true,align:"center"},{name:"purchased",width:50,sortable:true,align:"center"},{name:"locationTypeName",width:70,sortable:true,align:"center"},{name:"deliveryTypeName",width:75,sortable:true,align:"center"},{name:"isApprovedImg",width:60,sortable:true,align:"center",formatter:_this.yesNoGridImgFormatter},{name:"isFulfilledImg",width:60,sortable:true,align:"center",formatter:_this.yesNoGridImgFormatter},{name:"usedDesc",width:45,sortable:true,align:"center"},{name:"companyName",width:120,sortable:true,align:"left"}];var knownWidth=0;var missing=[];for(var ci=0;ci<colModel.length;ci++){if(!colModel[ci]['hidden']){if($.isNumeric(colModel[ci]['width'])){knownWidth+=Number(colModel[ci]['width']);}
else{missing.push(colModel[ci]['name']);}}}
if(missing.length>0){var extraWidth=this.resultsWrapper.width()-knownWidth;var perExtra=extraWidth/missing.length;for(var ci=0;ci<colModel.length;ci++){if(_.contains(missing,colModel[ci]['name'])){var w=(perExtra<extraWidth)?perExtra:extraWidth;colModel[ci]['width']=w;extraWidth=extraWidth-perExtra;}}}
this.resultsGrid.jqGrid('GridUnload');this.resultsGrid.jqGrid({datatype:"local",data:this.requests,width:this.resultsWrapper.width(),height:this.getIntendedGridHeight(),beforeSelectRow:function(rowid,e){return false;},rowNum:this.requests.length,colNames:["RequestId","Requestor","Game","Created","Recipient","Type","Comp","Purch","Location","Delivery","Approved","Fulfilled","Used","Company"],colModel:colModel,ondblClickRow:function(rowid){__masterSettings.removeSelection();window.open(__masterSettings.rootUrl+'reqInfo.aspx?request='+rowid);}});}
else{this.resultsGrid.jqGrid('clearGridData');if(this.requests.length>0){this.resultsGrid.jqGrid('setGridParam',{datatype:'local',data:this.requests,rowNum:this.requests.length}).trigger('reloadGrid');}}
_this.resultsWrapper.find('#gbox_respGrid').first().css('border','none');this.showHideFilters(false);}
__masterSettings.hideOverlay();}
this.yesNoGridImgFormatter=function(cellvalue,options,rowObject){if(cellvalue&&cellvalue!=''){return'<img src="'+cellvalue+'" />';}
else{return'';}}
this.filterSubmit=function(){var _this=this;var vals=[];if(this.seasonSel&&this.seasonSel.val())vals.push(['season',this.seasonSel.val()]);if(this.gameSel&&this.gameSel.val())vals.push(['game',this.gameSel.val()]);if(this.viewForSel&&this.viewForSel.val())vals.push(['for',this.viewForSel.val()]);if(this.requestTypeSel&&this.requestTypeSel.val())vals.push(['reqtype',this.requestTypeSel.val()]);if(this.deptSel&&this.deptSel.val())vals.push(['deptid',this.deptSel.val()]);if(this.apprSel&&this.apprSel.val())vals.push(['appr',this.apprSel.val()]);if(this.txtRcp&&this.txtRcp.val()&&this.txtRcp.val()!='')vals.push(['rcp',this.txtRcp.val()]);if(this.rblRcp&&this.rblRcp.find('input:checked').length==1)vals.push(['rcpa',this.rblRcp.find('input:checked').first().val()]);var qs='';for(var i=0;i<vals.length;i++){if(i>0)qs+='&';qs+=vals[i][0]+'='+vals[i][1];}
var url=__masterSettings.serviceBaseUrl+'historyPrep.ashx?mode=search&'+qs;__masterSettings.showLoadingOverlay();$.getJSON(url,'',function(json){_this.processSearchResults(json);_this.searchCompleted();});}
this.isFilterVisible=function(){return this.filterWrapper.find('.primFilt').first().is(':visible');}
this.toggleFilters=function(){if(this.primaryFilter.is(':visible'))this.showHideFilters(false);else this.showHideFilters(true);}
this.showHideFilters=function(show){if(show){this.primaryFilter.show();this.resultsWrapper.css('opacity',.5);}
else{this.primaryFilter.hide();this.resultsWrapper.css('opacity',1);}}
this.refreshGameList=function(){var _this=this;var gameRefData=new refDataList();gameRefData.add(null,'Any',null,true);var selSeason=this.seasonSel.val();if($.IsNumeric(selSeason)){var gl=new gameList();$.ajax({url:__masterSettings.rootUrl+'_services/gameData.ashx?mode=list&season='+selSeason,type:'GET',dataType:'json',async:false,success:function(json){gl.createFromJson(json,false);}});gl.list=_.sortBy(gl.list,function(item){return item.gameDate;});for(var gi=0;gi<gl.list.length;gi++){var g=gl.list[gi];gameRefData.add(g.gameId,g.gameDate.format("MM/DD/YYYY")+' - '+g.opponentFullName,null,false);}}
this.gameSel.BindRefData(gameRefData.list);}
this.initialLoad=function(){this.refreshGameList();}
this.handleWindowResize=function(){if(!this.firstSearch){this.resultsGrid.setGridHeight(this.getIntendedGridHeight());}}
this.actionBtnClicked=function(msg){if(msg.sender=='historyFilter'){var arg=msg.arg;var container=this.filterWrapper.find('.filter_'+arg).first();if(container){var elCrit=container.find('.critSel').first();if(elCrit){if(arg=='recip'){elCrit.val('');this.setDefaultRcpStyle(true);}
else{elCrit.val(elCrit.find('option').first().val());}}}}}
this.setDefaultRcpStyle=function(fireChange){this.rblRcp.find('input').each(function(){var id=$(this).attr('id');var lbl=$('label[for="'+id+'"]').first();if(lbl.attr('for')=='rbRcpContains'){$(this).prop('checked',true);}
else{$(this).prop('checked',false);}});if(fireChange){this.rblRcp.change();}}
this.initialize=function(filterWrapperId,resultsWrapperId){var _this=this;this.filterWrapper=$('#'+filterWrapperId);this.resultsWrapper=$('#'+resultsWrapperId);this.resultsGrid=this.resultsWrapper.find('#respGrid').first();this.primaryFilter=this.filterWrapper.find('.primFilt').first();this.seasonSel=this.filterWrapper.find('.season').first();this.gameSel=this.filterWrapper.find('.game').first();this.viewForSel=this.filterWrapper.find('.viewFor').first();this.requestTypeSel=this.filterWrapper.find('.requestType').first();this.deptSel=this.filterWrapper.find('.dept').first();this.apprSel=this.filterWrapper.find('.appr').first();this.txtRcp=this.filterWrapper.find('.recip').first();this.rblRcp=this.filterWrapper.find('.rblRcp').first();this.seasonSel.on('change',function(){_this.refreshGameList();});$('.rblCrit').change(function(){$(this).find('input').each(function(){var id=$(this).attr('id');var lbl=$('label[for="'+id+'"]').first();if($(this).is(':checked')){lbl.css('font-weight','900');}
else{lbl.css('font-weight','100');}});});this.setDefaultRcpStyle(true);this.filterWrapper.find('.filtSubmit').on('click',function(){_this.filterSubmit();});this.filterWrapper.find('.filterHeader').on('click',function(){_this.toggleFilters();});$(window).resize(function(){_this.handleWindowResize();});$(document).on("iconButtonClicked",function(e){_this.actionBtnClicked(e.message);});this.filterWrapper.find('.filterBoxRight').each(function(){var remBtnHtml='<img class="iconButton imgClear" data-name="xs" data-arg="'+$(this).data('arg')+'" src="'+__masterSettings.rootUrl+_this.iconButtonMgr.getImgRelUrl('xs')+'" />';$(this).html(remBtnHtml);});this.iconButtonMgr.latch('historyFilter',this.filterWrapper);this.resultsWrapper.show();this.showHideFilters(true);this.filterWrapper.onEnterKey(function(e,el){_this.filterWrapper.find('.filtSubmit').click();return true;});}}﻿
function user(){this.externalEnabled=true;this.winAuth=null;}
function settings(){this.serviceBaseUrl='';this.rootUrl='';this.today=null;this.gameCalToday=null;this.season=null;this.currentUser=null;this.isCtrl=false;this.isPostback=false;this.alerterForm=null;this.alerterModal=null;this.alerterOverlay=null;this.init=function(){var _this=this;$(document).keydown(function(event){if(event.which=="17"){_this.isCtrl=true;}
else if(event.which===8){_this.handleBackspace(event,!$(event.target).is("input:not([readonly]):not([type=radio]):not([type=checkbox]), textarea, [contentEditable], [contentEditable=true]"));}});$(document).keyup(function(){_this.isCtrl=false;});}
this.canShowExternalEdit=function(){return this.currentUser&&this.currentUser.externalEnabled&&this.currentUser.winAuth;}
this.setupAlerter=function(overlayElement,modalContainer){var _this=this;this.alerterModal=modalContainer;this.alerterOverlay=overlayElement;this.alerterOverlay.on('click',function(){_this.closeAlert();});this.alerterForm=new alerter();this.alerterForm.initialize(this.alerterModal);}
this.showOverlay=function(){var req=new overlayRequest(true,null);$.event.trigger({type:"overlayRequested",message:req,time:new Date()});}
this.showLoadingOverlay=function(imgType){var req=new overlayRequest(true,null);req.imageType=(imgType)?imgType:'block';$.event.trigger({type:"overlayRequested",message:req,time:new Date()});}
this.hideOverlay=function(){var req=new overlayRequest(false,null);$.event.trigger({type:"overlayRequested",message:req,time:new Date()});}
this.closeAlert=function(){if(this.alerterForm){this.alerterForm.setMessage('');this.alerterModal.hide();this.alerterOverlay.hide();}}
this.alert=function(msg,name){if(this.alerterForm){this.alerterForm.setMessage(msg);this.alerterOverlay.show();this.alerterModal.MiddleMiddle();this.alerterModal.show();}
else{alert(msg);}}
this.reloadPageHard=function(){location.reload(true);}
this.copyToClipboard=function(textToCopy){$.event.trigger({type:"clipboardCopierRequested",message:textToCopy,time:new Date()});}
this.selfRefreshCompleted=function(resp){if(resp.success){__masterSettings.alert('Successfully refreshed');this.reloadPageHard();}
else{__masterSettings.alert('An error occurred while trying to refresh account. Please try again later.');}}
this.refreshSelf=function(withWarning){var dorefresh=false;if(withWarning)dorefresh=confirm("Refreshing your account will cause the page to reload and you may have to re-enter any data you've entered on the page. Are you sure you want to continue?");else dorefresh=true;if(dorefresh){var _this=this;var req={};req['action']='refresh';var url=this.serviceBaseUrl+'userServices.ashx';$.ajax({url:url,type:'post',data:JSON.stringify(req),success:function(json){_this.selfRefreshCompleted(json,false);}});}}
this.removeSelection=function(){if(window.getSelection)window.getSelection().removeAllRanges();else if(document.selection)document.selection.empty();}
this.handleBackspace=function(e,willPageNav){}
this.masterFormatting=function(containerElement){containerElement.find('.submit').css('cursor','pointer');containerElement.find('.submit').on('mouseover focus',function(){$(this).addClass('submitHighlight');});containerElement.find('.submit').on('mouseout blur',function(){$(this).removeClass('submitHighlight');});containerElement.find('.submit').each(function(){$(this).attr('tabindex','0');$(this).onSpacebar(function(e,el){el.trigger('click');return true;});});containerElement.find('.choose').on('mouseover',function(){$(this).addClass('chooseHighlight');});containerElement.find('.choose').on('mouseout',function(){$(this).removeClass('chooseHighlight');});setTimeout(function(){containerElement.find('img.qtBottomCenter').each(function(){var btn=$(this);if(btn.data('hover')){btn.qtip({content:btn.data('hover'),position:{my:'top center',at:'bottom center'},style:{classes:'iconButtonTipContent',tip:{corner:'top center'}}});}});containerElement.find('img.qtCenterRight').each(function(){var btn=$(this);if(btn.data('hover')){btn.qtip({content:btn.data('hover'),position:{my:'top left',at:'top right'},style:{classes:'iconButtonTipContent',tip:{corner:'center left'}}});}});},800);}}
function alerter(){this.wrapper=null;this.msgdiv=null;this.setMessage=function(msg){msg=msg.replace('\r','');var lines=lines=msg.split('\n');var newMsg='';for(var i=0;i<lines.length;i++){newMsg+='<div class="alertLine">'+lines[i]+'</div>';}
this.msgdiv.html(newMsg);}
this.initialize=function(containerElement){this.wrapper=containerElement.find('.alertWrapper').first();this.msgdiv=this.wrapper.find('.alertMessage').first();}}
function modal(){this.element=null;this.caller=null;this.location='centercenter';this.setup=function(element,caller){this.element=element;this.caller=caller;}
this.preFadeIn=function(){}
this.postFadeIn=function(){}
this.preFadeOut=function(){return true;}
this.postFadeOut=function(){}}
function overlayRequest(show,modalToShow){this.show=show;this.modalToShow=modalToShow;this.imageType=null;}
function alertRequest(name,msg){this.name=name;this.msg=msg;}
function pgOverlay(){this.overlay=null;this.imageDiv=null;this.image=null;this.modal=null;this.ibMap=new iconButtons();this.build=function(overlayId){var _this=this;this.overlay=$('#'+overlayId);this.imageDiv=$('#'+overlayId+'Img');this.image=this.imageDiv.find('.overlayImage').first();this.overlay.on('click',function(){_this.handleOverlayClick();});$(document).on("overlayRequested",function(e){_this.handleRequested(e.message);});}
this.handleRequested=function(overlayRequest){var _this=this;if(overlayRequest.show){this.modal=overlayRequest.modalToShow;this.overlay.fadeIn('fast',function(){});if(this.imageDiv&&overlayRequest.imageType&&overlayRequest.imageType!=''){var loader='block';if(this.ibMap.map['load'].hasOwnProperty(overlayRequest.imageType))loader=overlayRequest.imageType;this.image.attr('src',__masterSettings.rootUrl+this.ibMap.map['load'][loader])
this.image.hide().delay(500).show(0);this.imageDiv.MiddleMiddle();this.imageDiv.fadeIn('fast',function(){});}
if(this.modal){this.modal.element.MiddleMiddle();this.modal.preFadeIn();this.modal.element.fadeIn('fast',function(){_this.modal.postFadeIn();});}}
else{var hide=true;if(this.modal){var modalHold=this.modal;hide=this.modal.preFadeOut();if(hide)this.modal.element.fadeOut('fast',function(){modalHold.postFadeOut();});}
if(hide){if(this.imageDiv)this.imageDiv.fadeOut('fast',function(){});this.overlay.fadeOut('fast',function(){});this.modal=null;}}}
this.handleOverlayClick=function(){var req=new overlayRequest(false,null);this.handleRequested(req);}}
function iconButtons(){this.map={};this.map['add']={};
this.map['add']['on']='public/images/add_32_on.png';
this.map['add']['off']='public/images/add_32_off.png';
this.map['folder']={};
this.map['folder']['on']='public/images/history_32_on.png';
this.map['folder']['off']='public/images/history_32_off.png';this.map['key']={};
this.map['key']['on']='public/images/key_32_on.png';
this.map['key']['off']='public/images/key_32_off.png';
this.map['users']={};
this.map['users']['on']='public/images/users_32_on.png';
this.map['users']['off']='public/images/users_32_off.png';this.map['opt']={};
this.map['opt']['on']='public/images/options_32_on.png';
this.map['opt']['off']='public/images/options_32_off.png';
this.map['info']={};
this.map['info']['on']='public/images/info_32_on.png';
this.map['info']['off']='public/images/info_32_off.png';
this.map['ball']={};
this.map['ball']['on']='public/images/ball_32_on.png';
this.map['ball']['off']='public/images/ball_32_off.png';this.map['approve']={};
this.map['approve']['on']='public/images/approve_32_on.png';
this.map['approve']['off']='public/images/approve_32_off.png';
this.map['modify']={};
this.map['modify']['on']='public/images/modify_32_on.png';
this.map['modify']['off']='public/images/modify_32_off.png';
this.map['delete']={};
this.map['delete']['on']='public/images/delete_32_on.png';
this.map['delete']['off']='public/images/delete_32_off.png';this.map['disapprove']={};
this.map['disapprove']['on']='public/images/disapprove_32_on.png';
this.map['disapprove']['off']='public/images/disapprove_32_off.png';
this.map['print']={};
this.map['print']['on']='public/images/print_32_on.png';
this.map['print']['off']='public/images/print_32_off.png';
this.map['support']={};
this.map['support']['on']='public/images/support_32_on.png';
this.map['support']['off']='public/images/support_32_off.png';
this.map['prev']={};
this.map['prev']['on']='public/images/prev2_32_on.png';
this.map['prev']['off']='public/images/prev2_32_off.png';
this.map['next']={};
this.map['next']['on']='public/images/next2_32_on.png';
this.map['next']['off']='public/images/next2_32_off.png';
this.map['cabinet']={};
this.map['cabinet']['on']='public/images/cabinet_32_on.png';
this.map['cabinet']['off']='public/images/cabinet_32_off.png';
this.map['activity']={};
this.map['activity']['on']='public/images/activity_32_on.png';
this.map['activity']['off']='public/images/activity_32_off.png';
this.map['uref']={};this.map['uref']['on']='public/images/uref_24_on.png';
this.map['uref']['off']='public/images/uref_24_off.png';this.map['prb']={};
this.map['prb']['on']='public/images/prb_24_on.png';
this.map['prb']['off']='public/images/prb_24_off.png';
this.map['x']={};
this.map['x']['on']='public/images/x_32_on.png';
this.map['x']['off']='public/images/x_32_off.png';
this.map['xs']={};this.map['xs']['on']='public/images/x_16_on.png';
this.map['xs']['off']='public/images/x_16_off.png';
this.map['load']={};
this.map['load']['pie']='public/images/pieLoader.gif';
this.map['load']['block']='public/images/blockLoader.gif';
this.map['approve']['attr']='<div>Icon made by <a href="http://picol.org" title="Picol">Picol</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['disapprove']['attr']='<div>Icon made by <a href="http://picol.org" title="Picol">Picol</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['folder']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['support']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['prev']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['next']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['cabinet']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['activity']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['uref']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['prb']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['modify']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['delete']['attr']='<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['add']['attr']='<div>Icon made by <a href="http://yanlu.de" title="Yannick">Yannick</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.map['info']['attr']='<div>Icon made by <a href="http://yanlu.de" title="Yannick">Yannick</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>';this.latch=function(sender,parentElement){var _this=this;parentElement.find('.iconButton').css('cursor','pointer');parentElement.find('.iconButton').on('mouseover',function(){$(this).attr('src',__masterSettings.rootUrl+_this.map[$(this).data('name')]['on']);});parentElement.find('.iconButton').on('mouseout',function(){$(this).attr('src',__masterSettings.rootUrl+_this.map[$(this).data('name')]['off']);});parentElement.find('.iconButton').on('click',function(){$.event.trigger({type:"iconButtonClicked",message:{sender:sender,icBtn:$(this),arg:$(this).data('arg'),name:$(this).data('name'),isCtrl:__masterSettings.isCtrl},time:new Date()});});}
this.getImgRelUrl=function(name,isOn){var onOff=(isOn)?'on':'off';return this.map[name][onOff];}}
function icBtn(name,action,order,dispName,cssClass){this.name=name;this.action=action;this.order=order;this.dispName=(typeof dispName!="undefined")?dispName:"";this.cssClass=(typeof cssClass!="undefined")?cssClass:null;}﻿
function requestTypeAvailability(){this.requestTypeCode='';this.available=0;this.hasLimit=true;this.isRequestable=false;this.requiresApproval=false;this.createFromJson=function(json){this.requestTypeCode=json.code;this.available=json.avail;this.hasLimit=json.isLimited;this.isRequestable=json.isReq;this.requiresApproval=json.reqAppr;}
this.limitDesc=function(){var desc='';if(this.hasLimit){desc='up to '+this.available;}
else{if(this.available){desc='up to '+this.available+'+';}
else{desc='no limit';}}
return desc;}
this.isValueValid=function(val){var valid=false;if($.isNumeric(val)){var tix=Number(val);if(!this.hasLimit||!this.available){valid=true;}
else{valid=tix<=this.available;}
if(tix<0){valid=false;}}
return valid;}
this.createEmpty=function(requestTypeCode){this.requestTypeCode=requestTypeCode;this.available=0;this.hasLimit=true;this.isRequestable=false;}}
function reqType(){this.code='';this.name='';this.deliveryTypes=new refDataList();this.locationTypes=new refDataList();this.defaultDeliveryType='';this.defaultLocationType='';this.createFromJson=function(json,allDeliveryTypes,allLocationTypes){this.deliveryTypes=new refDataList();this.deliveryTypes.list=[];this.locationTypes=new refDataList();this.locationTypes.list=[];this.code=json.code;this.name=json.name;this.defaultDeliveryType=json.defd;this.defaultLocationType=json.defl;for(var di=0;di<json.dels.length;di++){this.deliveryTypes.list.push(_.find(allDeliveryTypes.list,function(i){return i.identifier==json.dels[di];}));}
if(this.code!="PERS"){for(var li=0;li<json.locs.length;li++){if(json.locs[li]!="NONE")
this.locationTypes.list.push(_.find(allLocationTypes.list,function(i){return i.identifier==json.locs[li];}));}}else{for(var li=0;li<json.locs.length;li++){if(json.locs[li]=="NONE")
this.locationTypes.list.push(_.find(allLocationTypes.list,function(i){return i.identifier==json.locs[li];}));}}}}
function userGameAvailability(){this.requestTypes=[];this.rtCompAvail=[];this.rtPurchAvail=[];this.isRequestable=false;this.createFromJson=function(json,reqSettings){this.rtCompAvail=[];this.rtPurchAvail=[];this.requestTypes=[];this.isRequestable=json.requestable;var validRTs=[];for(var ci=0;ci<json.ca.length;ci++){var a=new requestTypeAvailability();a.createFromJson(json.ca[ci]);if(a.isRequestable){this.rtCompAvail.push(a);validRTs.push(a.requestTypeCode);}}
for(var ci=0;ci<json.pa.length;ci++){var a=new requestTypeAvailability();a.createFromJson(json.pa[ci]);if(a.isRequestable){this.rtPurchAvail.push(a);validRTs.push(a.requestTypeCode);}}
for(var rti=0;rti<json.rts.length;rti++){var rt=new reqType();rt.createFromJson(json.rts[rti],reqSettings.deliveryTypes,reqSettings.locationTypes);if(_.where(validRTs,rt.code).length>0){this.requestTypes.push(rt);}}}
this.getRequestTypesRefDataList=function(){var rdl=new refDataList();rdl.list=[];for(var rti=0;rti<this.requestTypes.length;rti++){var rt=this.requestTypes[rti];rdl.add(rt.code,rt.name,null,false);}
return rdl;}
this.getRequestType=function(code){return _.find(this.requestTypes,function(i){return i.code==code;});}
this.getCompAvailability=function(requestTypeCode){var avail=_.find(this.rtCompAvail,function(a){return a.requestTypeCode==requestTypeCode;});if(!avail){avail=new requestTypeAvailability();avail.createEmpty();}
return avail;}
this.getPurchAvailability=function(requestTypeCode){var avail=_.find(this.rtPurchAvail,function(a){return a.requestTypeCode==requestTypeCode;});if(!avail){avail=new requestTypeAvailability();avail.createEmpty();}
return avail;}}
function requestSettings(){this.requestFor=new refDataList();this.deliveryTypes=new refDataList();this.locationTypes=new refDataList();this.game=null;this.loaded=function(parent){}
this.load=function(parent,gameId){var _this=this;var initUrl=__masterSettings.serviceBaseUrl+'requestPrep.ashx?dly=0&mode=init&game='+gameId;$.getJSON(initUrl,'',function(json){_this.initDataRetrieved(json);_this.loaded(parent);});}
this.initDataRetrieved=function(jsonData){this.game=null;this.requestFor.createFromJson(jsonData.reqFor);this.deliveryTypes.createFromJson(jsonData.delTypes);this.locationTypes.createFromJson(jsonData.locTypes);if(jsonData.game){this.game=new game();this.game.createReqGameFromJson(jsonData.game);}}
this.canRequestForOthers=function(){return this.requestFor&&this.requestFor.list.length>1;}}
function newRequest(gameId){this.isReady=false;this.currUser=null;this.gameId=gameId;this.wrapper=null;this.reqWrapper=null;this.userChangeDisp=null;this.userChangeLink=null;this.userChangeModal=new modal();this.userChangeModal.postFadeIn=function(){this.caller.userChangeSelector.focus();}
this.userChangeSelector=null;this.userChangeSelectorLoaded=false;this.requestTypeSelector=null;this.approvalMsg=null;this.txtComp=null;this.txtPurch=null;this.txtFName=null;this.txtLName=null;this.companyName=null;this.sponsorName=null;this.txtComments=null;this.commentsBlock=new maxBlock();this.instructionsBlock=new maxBlock();this.txtInstructions=null;this.locationSelector=null;this.deliverySelector=null;this.createValidator=null;this.createSubmitter=null;this.divValid=null;this.divInvalid=null;this.settings=new requestSettings();this.availability=new userGameAvailability();this.compAvail=new requestTypeAvailability();this.purchAvail=new requestTypeAvailability();this.errors=[];this.warnings=[];var popup=false;this.initialize=function(wrapperId){var _this=this;this.isReady=false;this.currUserId=currUserId;this.wrapper=$('#'+wrapperId);this.reqWrapper=this.wrapper.find('.reqWrapper').first();this.approvalMsg=this.wrapper.find('.approvalMsg').first();this.divInvalid=this.wrapper.find('#divInvalid').first();this.divValid=this.wrapper.find('#divValid').first();this.userChangeDisp=this.reqWrapper.find('.divRequestFor').first();this.userChangeLink=this.reqWrapper.find('.requestForName').first();this.userChangeSelector=this.wrapper.find('.selUserRequestChange').first();this.requestTypeSelector=this.wrapper.find('.selRequestType').first();this.txtComp=this.wrapper.find('.txtComp').first();this.txtPurch=this.wrapper.find('.txtPurch').first();this.txtFName=this.wrapper.find('.txtFName').first();this.companyName=this.wrapper.find('.companyName').first();this.sponsorName=this.wrapper.find('.sponsorName').first();this.txtLName=this.wrapper.find('.txtLName').first();this.txtComments=this.wrapper.find('.txtComments').first();this.commentsBlock.init(this.wrapper.find('.commentsBlock').first(),250);this.txtInstructions=this.wrapper.find('.txtInstructions').first();this.instructionsBlock.init(this.wrapper.find('.instructionsBlock').first(),250);this.locationSelector=this.wrapper.find('.selLocation').first();this.deliverySelector=this.wrapper.find('.selDelivery').first();this.createValidator=this.wrapper.find('.createRequestValidate').first();this.createSubmitter=this.wrapper.find('.createRequest').first();this.requestTypeSelector.on('change',function(){_this.handleRequestTypeChange();});this.userChangeLink.on('click',function(){_this.promptChangeUser();});this.userChangeModal.setup(this.wrapper.find('.userRequestChange').first(),this);this.userChangeModal.element.find('.change').first().on('click',function(){_this.changeUser(_this.userChangeSelector.val());__masterSettings.hideOverlay();});this.userChangeModal.element.onEnterKey(function(e,el){_this.userChangeModal.element.find('.change').first().click();return true;});this.createValidator.on('click',function(){__masterSettings.showLoadingOverlay();_this.validateRequest();if(_this.errors.length>0){__masterSettings.hideOverlay();__masterSettings.alert('Please fix the following problems:\n'+_this.errors.join('\n'));}
else{if(_this.warnings.length>0){alert(_this.warnings.join('\n'));}
_this.submitRequest();}});var divPurchase=this.wrapper.find('.divPurchase').first();if(__masterSettings.currentUser&&!__masterSettings.currentUser.hasCc){divPurchase.addClass('noCc');}
__masterSettings.showLoadingOverlay();this.settings.load(_this,this.gameId);}
this.settings.loaded=function(parent){var game=parent.settings.game;if(game){parent.reqWrapper.find('.reqGameDetailsDate').first().html(game.gameDate.format("MM/DD/YYYY"));var futureDate=game.gameDate.format("MM/DD/YYYY");var d=new Date();var month=d.getMonth()+1;var day=d.getDate();var output=((''+month).length<2?'0':'')+month+'/'+
((''+day).length<2?'0':'')+day+'/'+
d.getFullYear();var nfuture=futureDate.split("/");var ndate=output.split("/");var demand=game.demand;if(Number(nfuture[0])!=Number(ndate[0])){if((Number(nfuture[1])>=Number(ndate[1]))||(Number(nfuture[0])-Number(ndate[0])!=1)){alert("Only business requests can be made for games more than a month ahead.");popup=true;}}
if(popup==false&&(demand=="High Demand"||demand=="Very High Demand")){alert("Due to the High Demand of this game, employees can only obtain half of their allotted amount.");popup=true;}
parent.reqWrapper.find('.reqGameDetailsOpp').first().html(game.opponentShortName+' '+game.opponentNickName);parent.reqWrapper.find('.reqGameDetailsLvl').first().html(game.demand);parent.reqWrapper.find('.reqGameDetailsReqState').first().html(game.requestState);var promos='';if(game.promotions.length>0){for(var pi=0;pi<game.promotions.length;pi++){if(pi>0)promos+=', ';var p=game.promotions[pi];promos+=p.promo;if(p.presby||p.presby!='')promos+=' (presented by '+p.presby+')';if(p.restr&&p.restr!='')promos+=' *'+p.restr;}}
else{promos+='No promotions';}
parent.reqWrapper.find('.reqGameDetailsPromos').first().html(promos);}
if(parent.settings.canRequestForOthers())parent.userChangeDisp.show();else parent.userChangeDisp.hide();parent.isReady=true;__masterSettings.hideOverlay();parent.ready();}
this.build=function(userId){this.changeUser(userId);}
this.ready=function(){}
this.validateRequest=function(){this.errors=[];this.warnings=[];var c=this.txtComp.val();var cv=this.compAvail.isValueValid(c);var p=this.txtPurch.val();var pv=this.purchAvail.isValueValid(p);var fn=this.txtFName.val();var ln=this.txtLName.val();var nv=!(ln.trim().length==0||fn.trim().length==0);var cmtv=this.commentsBlock.isContentValid();var instrv=this.instructionsBlock.isContentValid();var total=Number(c)+Number(p);var notes=!(this.requestTypeSelector.val()!="PERS"&&this.txtComments.val().trim().length==0);var company=!(this.requestTypeSelector.val()!="PERS"&&(this.companyName.val().trim().length==0||this.companyName.val().trim().length<3));var companyLength=!(this.requestTypeSelector.val()!="PERS"&&this.companyName.val().trim().length<2);if(!cv||total<=0)this.errors.push('Comp tickets invalid.');if(!pv)this.errors.push('Purchased tickets invalid.');if(cv&&pv&&Number(c)==0&&Number(p)==0)this.errors.push('Must enter either comp or puchased ticket amount.');if(!nv)this.errors.push('Must enter attendee full name.');if(!cmtv)this.errors.push('Personal notes are too long.');if(!instrv)this.errors.push('Ticket Office instructions are too long.');if(!company)this.errors.push('Please enter a valid company name for this business request. (Must be 3 or more characters long)');if(!notes)this.errors.push("Please fill in the business purpose for this request.");if(this.errors.length==0&&parseInt(this.txtPurch.val())>0&&__masterSettings.currentUser&&!__masterSettings.currentUser.hasCc){this.warnings.push('Your request will be submitted but you do not currently have a credit card on file.');var ccMsg=(__masterSettings.currentUser.hasAd)?'follow the instructions for submitting a credit card in the help section of the eComps home page.':'check with your manager on how to submit a credit card to the ticket office.';this.warnings.push('To make sure this request can be fulfilled please '+ccMsg);}}
this.submitRequest=function(){var _this=this;var req={};if(this.requestTypeSelector.val()=='BSPO')
req['sponsorTypeName']=this.sponsorName.val();else
req['sponsorTypeName']='';req['requestor']=this.currUser.identifier;req['gameId']=this.gameId;req['requestTypeCode']=this.requestTypeSelector.val();req['comp']=this.txtComp.val();req['purchased']=this.txtPurch.val();req['locationTypeCode']=this.locationSelector.val();req['deliveryTypeCode']=this.deliverySelector.val();req['fname']=this.txtFName.val();req['lname']=this.txtLName.val();req['companyName']=this.companyName.val();req['comments']=(this.txtComments.val()).replace(/\s+/g,' ').trim();req['instr']=(this.txtInstructions.val()).replace(/\s+/g,' ').trim();var url=__masterSettings.serviceBaseUrl+'createRequest.ashx?dly=0';$.post(url,JSON.stringify(req),_this.submitRequestCompleted);}
this.submitRequestCompleted=function(newReqResp){if(newReqResp&&newReqResp.created){__masterSettings.hideOverlay();var newurl=__masterSettings.rootUrl+'reqInfo.aspx?request='+newReqResp.requestId;if(!newReqResp.approved){__masterSettings.alert('The request has been successfully submitted but it requires approval.\nYou will be notified by email when the request has been approved or not approved.');setTimeout(function(){window.location=newurl;},5000);}
else{window.location=newurl;}}
else{var alertLines=[];alertLines.push('Unable to create this request for the following reason(s):');if(newReqResp&&newReqResp.errors&&newReqResp.errors.length>0){for(var ei=0;ei<newReqResp.errors.length;ei++){alertLines.push(newReqResp.errors[ei].desc);}}
else{alertLines.push('eComps System error');}
__masterSettings.alert(alertLines.join('\n'));__masterSettings.hideOverlay();}}
this.changeUser=function(userId){var _this=this;userId=userId.toLowerCase();this.currUser=null;this.currUser=_.find(this.settings.requestFor.list,function(i){return i.identifier.toLowerCase()==userId;});this.userChangeLink.html(this.currUser.display);var nameArr=this.currUser.parentIdentifier.split('|');var fname=(nameArr.length>0)?nameArr[0]:'';var lname=(nameArr.length>1)?nameArr[1]:'';this.txtFName.val('');this.txtLName.val('');$.ajax({url:__masterSettings.serviceBaseUrl+'requestPrep.ashx?dly=0&mode=alloc&game='+this.gameId+'&for='+this.currUser.identifier,type:'GET',dataType:'json',async:false,success:function(json){_this.availability.createFromJson(json,_this.settings);}});_this.handleAllocationChange();}
this.handleAllocationChange=function(){var rts=this.availability.getRequestTypesRefDataList().list;if(rts.length>0){this.divValid.show();this.divInvalid.hide();this.requestTypeSelector.BindRefData(this.availability.getRequestTypesRefDataList().list);this.requestTypeSelector.val('PERS');this.handleRequestTypeChange();if(rts.length==1&&popup==false&&this.requestTypeSelector.val()=="BADM"){alert("All personal ticket allocations for this day have been used.");popup=true;}}
else{this.divValid.hide();this.divInvalid.show();this.divInvalid.html('This game is not requestable for the current user.');}}
this.handleRequestTypeChange=function(){var requestTypeCode=this.requestTypeSelector.val();var reqType=this.availability.getRequestType(requestTypeCode);this.compAvail=this.availability.getCompAvailability(requestTypeCode);this.purchAvail=this.availability.getPurchAvailability(requestTypeCode);this.txtComp.val('0');this.txtPurch.val('0');this.reqWrapper.find('.lblCompLimit').first().html(this.compAvail.limitDesc());this.reqWrapper.find('.lblPurchLimit').first().html(this.purchAvail.limitDesc());this.locationSelector.BindRefData(reqType.locationTypes.list,reqType.defaultLocationType);this.deliverySelector.BindRefData(reqType.deliveryTypes.list,reqType.defaultDeliveryType);if(requestTypeCode!='PERS'){this.reqWrapper.find('.CompanyRow').first().attr('style','display:normal');if(requestTypeCode=='BSPO')
this.reqWrapper.find('.SponsorRow').first().attr('style','display:normal');else
this.reqWrapper.find('.SponsorRow').first().attr('style','display:none');this.reqWrapper.find('.lblTxtMaxLimit').first().html('BUSINESS PURPOSE <span class= maxBlockLbl></span>');}
else{this.reqWrapper.find('.SponsorRow').first().attr('style','display:none');this.reqWrapper.find('.CompanyRow').first().attr('style','display:none');this.reqWrapper.find('.lblTxtMaxLimit').first().html('NOTES FOR PERSONAL USE <span class= maxBlockLbl></span>');}
if((this.compAvail&&this.compAvail.requiresApproval)||(this.purchAvail&&this.purchAvail.requiresApproval)){this.approvalMsg.show();}
else{this.approvalMsg.hide();}}
this.promptChangeUser=function(){if(!this.userChangeSelectorLoaded){this.userChangeSelector.find('option').remove();for(var ui=0;ui<this.settings.requestFor.list.length;ui++){var u=this.settings.requestFor.list[ui];var opt='<option value="'+u.identifier+'">'+u.display+'</option>';this.userChangeSelector.append(opt);}}
var _this=this;var req=new overlayRequest(true,this.userChangeModal);$.event.trigger({type:"overlayRequested",message:req,time:new Date()});}}